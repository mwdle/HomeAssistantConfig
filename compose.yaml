services: # TODO: Include resource limits for all containers in this stack
  MQTT:
    image: eclipse-mosquitto
    container_name: MQTT
    restart: unless-stopped
    hostname: mqtt
    networks:
      - HomeAssistant
      - Frigate
    volumes:
      - ${DOCKER_VOLUMES}/MQTT/log:/mosquitto/log
      - ${DOCKER_VOLUMES}/MQTT/data:/mosquitto/data
      - ${DOCKER_VOLUMES}/MQTT/config:/mosquitto/config

  Frigate:
    image: ghcr.io/blakeblackshear/frigate:stable
    container_name: Frigate
    restart: unless-stopped
    privileged: true # Must be privileged to enable hardward acceleration. This allows access intel_gpu_top command for gpu stats.
    shm_size: "128mb" # https://docs.frigate.video/frigate/installation/#calculating-required-shm-size
    devices:
      - /dev/dri/renderD128 # For intel hwaccel, needs to be updated for your hardware
    ports:
      - 8555:8555 # WebRTC
    hostname: frigate
    networks:
      - Frigate
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${DOCKER_VOLUMES}/Frigate/config:/config
      - ${DOCKER_VOLUMES}/Frigate/storage:/media/frigate
      - type: tmpfs # Optional: 1GB of memory, reduces SSD/SD Card wear
        target: /tmp/cache
        tmpfs:
          size: 1000000000
    environment:
      FRIGATE_RTSP_USER: "${RTSP_USER}"
      FRIGATE_RTSP_PASSWORD: "${RTSP_PASSWORD}"
      FRIGATE_MQTT_USER: "${MQTT_USER}"
      FRIGATE_MQTT_PASSWORD: "${MQTT_PASSWORD}"
    depends_on:
      - MQTT

  MusicAssistant:
    container_name: MusicAssistant
    image: ghcr.io/music-assistant/server:latest
    restart: unless-stopped
    hostname: musicassistant
    networks:
      AAA_LAN:
      MusicAssistant:
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${DOCKER_VOLUMES}/MusicAssistant/data:/data
      - ${MUSIC_VOLUME}:/media:ro # Read only is necessary if you're mounting music from a folder within Nextcloud's internal storage in order to prevent data corruption and other issues.

  Chrome: # Allows running Selenium scripts using Pyscript within Home Assistant
    image: selenium/standalone-chrome:latest
    container_name: Chrome
    restart: unless-stopped
    hostname: chrome
    shm_size: 2g # Required unless using chrome option `--disable-dev-shm-usage`
    networks:
      - Chrome
    environment:
      - SE_START_VNC=false
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 2GB

  HomeAssistant:
    image: ghcr.io/home-assistant/home-assistant:latest
    container_name: HomeAssistant
    restart: unless-stopped
    hostname: homeassistant
    networks:
      AAA_LAN:
      HomeAssistant:
      Chrome: # Used by pyscript `router_rebooter` module for Selenium access within HA
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - ${DOCKER_VOLUMES}/HomeAssistant/config:/config
      - ./configuration.yaml:/config/configuration.yaml:ro # Mount the configuration.yaml from this repository into the container
      - ./pyscript:/config/pyscript:ro # Mount pyscript apps folder from this repository into the container
      - ./pyscript_modules:/config/pyscript_modules:ro # Mount pyscript modules folder from this repository into the container
    # Custom environment variables used within Pyscript for `router_rebooter` app:
    environment:
      - ROUTER_PASSWORD=${ROUTER_PASSWORD}
      - EXTENDER_PASSWORD=${EXTENDER_PASSWORD}
    depends_on:
      - MQTT
      - Frigate
      - MusicAssistant

networks:
  AAA_LAN:
    name: AAA_LAN
    external: true
  HomeAssistant:
    name: HomeAssistant
    external: true
  Chrome:
    name: Chrome
    external: true
  Frigate:
    name: Frigate
    external: true
  MusicAssistant:
    name: MusicAssistant
    external: true
